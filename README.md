UniAlert
=====

UniAlert can help the IT department by showing at a glance the outcome of all backups. It interprets the emails of results of the backup tasks and generates a report with the summary of the last 60 days.

UniAlert consists of two Python scripts:

- UA_Mailer.py : Filters and interprets emails corresponding to the results of backup jobs.
- UA_Reporte.py: Collects the data generated by UA_Mailer and generates a summary that will be sent by email.

Requeriments
-----------------
- Python 3.8
- Tzlocal library 2.1 
- Pillow Library 8.1.0

Install
-----------------

After verifying that you have installed the correct version of Python, we will have to install the necessary libraries:

```
pip install tzlocal==2.1
pip install Pillow==8.1.0
```

Now we can copy the files *UA_Mailer.py*, *UA_Reporter.py* and *filters.json* in the path that we want.  p.e: `/opt/unialert`

After editing the *filters.json* file and adjusting to our needs, we must configure cron tasks to run *UA_Mailer* every hour and *UA_Reporter* once a day.

```
0 * * * * root python /opt/unialert/UA_mailer.py
0 8 * * * root python /opt/unialert/UA_reporter.py
```

How to config UniAlert
-----------------------------
To configure UniAlert, edit the filters.json file as shown below:

| Parameter                  |  Description
----------------------|----------------------
|last_update  | Date from which start comparing emails with filters. (Format %d/%m/%Y %H:%M:%S) |
|mail_config| Mail configuration. |
|mail_config \ from | Email address from which the summary is sent (myaccount@mydomain.com)|
|mail_config \ mail_server | Imap host server  (imap.mydomain.com)|
|mail_config \ password | Account password |
|mail_config \ port | Port number of the imap server|
|mail_config \ smtp_port | Port number of the smtp server|
|mail_config \ smtp_server | Smtp host server  (smtp.mydomain.com)|
|mail_config \ smtp_ssl | 1 = SMTP with SSL , 0 = SMTP without SSL |
|mail_config \ ssl | 1 = IMAP with SSL , 0 = IMAP without SSL |
|mail_config \ to | Email where to send the report (toaccount@mydomain.com) |
|mail_config \ user | Account username |
|pcpfilters| List of a filters definitions|

How to define filters
-------------------------
Filters are defined as a list within the pcpfilters field with the following parameters:

| Parameter                  |  Description
----------------------|----------------------
|delay_days_error | Maximum days without receiving emails matching this filter. If it is exceeded, the status will be marked as an error. |
|filter| Filter name|
|id_filter| Used to identify emails corresponding to this filter|
|id_filter \ from | Address of the sender to match |
|id_filter \ subject | Part of the subject that must match|
|id_success | Identifies if the result is success |
|id_success \ subject| Part of the subject that must match|
|id_success \ body | Part of the body that must match|
|id_error | Identifies if the result is error |
|id_error \ subject| Part of the subject that must match|
|id_error \ body | Part of the body that must match|
|type | type of filter ( search or cobian) |


There are the following types of filters:

- search : Compare the body and subject of emails with the filter to retrieve the result
```
Example of search filter:
{
    "delay_days_error": 7, 
    "filter": "Sample search filter", 
    "id_error": {
        "body": "", 
        "subject": "backup failed"
    }, 
    "id_filter": {
        "from": "alerts@mydomain.com", 
        "subject": "vzdump backup status (node01.proxmox.local)"
    }, 
    "id_success": {
        "body": "", 
        "subject": "backup successful"
    }, 
    "type": "search"
}
```

- cobian : Identifies the number of errors reported by CobianBackup to determine the result. This filter needs to configure cobian backup to insert [n] into the email subject, where n is the number of errors.
```
{
    "delay_days_error": 3, 
    "filter": "Sample CobianBackup filter", 
    "id_filter": {
        "from": "alerts@mydomain.com", 
        "subject": "COBIAN: jobname"
    }, 
    "type": "cobian"
}
```

The Report
---------------
Once configured correctly UniAlert and after collecting information with UA_mailer, you can already run UA_Reporter, which will send an email with a report like the following:

![Sam`ple report](http://www.pcpractico.es/img2/reportpng.PNG)